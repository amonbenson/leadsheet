%!TeX program = LuaLaTeX
%
% leadsheet-sections.sty
% Song section environments and tabular formatting for the leadsheet package
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{leadsheet-sections}[2025/12/29 Leadsheet section environments]

\RequirePackage[framemethod=tikz]{mdframed}
\RequirePackage{array}

\ExplSyntaxOn

% ============================================================================
% LEADSHEET TABULAR ENVIRONMENT
% ============================================================================
% The lstabular environment provides a specialized table for displaying
% lyrics and chords. It preprocesses the content to expand chord symbols,
% barlines, and other musical notation.

% --- Public environment ---

% lstabular environment
% Creates a tabular layout for lyrics and chords with automatic preprocessing.
%
% The environment accepts the table body and:
%   1. Preprocesses all chord symbols (^Cm7), barlines (|), and special syntax
%   2. Sets up optimal column spacing based on font metrics
%   3. Creates a left-aligned table with up to 32 columns
%
% Usage:
%   \begin{lstabular}
%     & ^Cm7 & ^F7 & ^Bb \\
%     <> Just a & steel town girl & on a & Saturday night \\
%   \end{lstabular}
%
\NewDocumentEnvironment { lstabular } { +b } {
    \group_begin:

    % Set column separation to half the width of a space character
    % This provides natural spacing that scales with the font
    \setlength{\tabcolsep}{0.5\fontdimen2\font}

    % Set spaceskip to allow white space to stretch infinitely
    \setlength{\spaceskip}{\fontdimen2\font plus 1fil}

    % Create a simple left-aligned table with 32 columns (no outer padding)
    % The table body is preprocessed inline to avoid # doubling
    \noindent%
    \vspace*{-\parskip}%
    \begin{tabular}{@{}*{32}{l}}
        \__leadsheet_preprocess:n { #1 }
    \end{tabular}%
    \vspace*{-\parskip}%

    \group_end:
} { }


% ============================================================================
% SONG SECTION ENVIRONMENTS
% ============================================================================
% Environments for creating labeled sections of a song (Verse, Chorus, etc.)
% with optional highlighting.

% --- songsection environment ---

% songsection environment
% Creates a labeled section of a song with a title.
%
% Usage:
%   \begin{songsection}{Verse 1}
%     & ^Cm7 & ^F7 \\
%     <> Just a & steel town girl \\
%   \end{songsection}
%
% Parameters:
%   #1 - Section title (e.g., "Verse 1", "Chorus", "Bridge")
%   #2 - Section content (lyrics and chords in lstabular format)
%
% \NewDocumentEnvironment { songsection } { m +b } {
%     \group_begin:

%     % Render the section title in large bold text
%     \noindent\textbf{\Large #1}%
%     \par\vspace*{0.5\lspagemargin}
%     \nopagebreak[4]

%     % Start the lyrics/chords table
%     % (content will be automatically preprocessed by lstabular)
%     \begin{lstabular}
%         #2
%     \end{lstabular}
%     \par\vspace*{\lspagemargin}

%     \group_end:
% } { }
\NewDocumentEnvironment { songsection } { m +b } {
    \group_begin:

    % Render the section title in large bold text
    \section*{#1}%
    \nobreak

    % Start the lyrics/chords table
    % (content will be automatically preprocessed by lstabular)
    \begin{lstabular}
        #2
    \end{lstabular}
    % \par\vspace*{\lspagemargin}

    \group_end:
} { }

% --- hlsongsection environment ---

% hlsongsection environment (highlighted song section)
% Creates a highlighted song section with a colored background.
%
% This is identical to songsection but wrapped in a colored frame,
% useful for emphasizing important sections like the chorus.
%
% Usage:
%   \begin{hlsongsection}{Chorus}
%     & ^Cm7 & ^F7 \\
%     <> And she's dancing \\
%   \end{hlsongsection}
%
% Parameters:
%   #1 - Section title (e.g., "Chorus", "Hook")
%   #2 - Section content (lyrics and chords)
%
% \NewDocumentEnvironment { hlsongsection } { m +b } {
%     \vspace*{-\lshlmargin}
%     \begin{mdframed}[
%         hidealllines=true,
%         backgroundcolor=yellow!65,
%         innerleftmargin=\lshlmargin,
%         innerrightmargin=\lshlmargin,
%         innerbottommargin=\dimexpr{},
%         innertopmargin=\lshlmargin,
%         leftmargin=-\lshlmargin,
%         rightmargin=-\lshlmargin,
%     ]
%         \begin{songsection}{#1}
%             #2
%         \end{songsection}
%     \end{mdframed}
%     \vspace*{-\lshlmargin}
% } { }
\NewDocumentEnvironment { hlsongsection } { m +b } {
    \vspace*{\LS@titlespacebefore-\LS@hlmargin}
    \begin{mdframed}[
        hidealllines=true,
        backgroundcolor=yellow!65,
        usetwoside=false,
        innerleftmargin=\LS@hlmargin,
        innerrightmargin=\LS@hlmargin,
        innertopmargin=\LS@hlmargin,
        innerbottommargin=\LS@hlmargin,
        leftmargin=-\LS@hlmargin,
        rightmargin=-\LS@hlmargin,
        skipabove=0pt,
        skipbelow=0pt,
    ]
        \vspace*{-\LS@titlespacebefore}
        \begin{songsection}{#1}
            #2
        \end{songsection}
    \end{mdframed}
    \vspace*{-\LS@hlmargin}
} { }


\ExplSyntaxOff

\endinput
