%!TeX program = LuaLaTeX
%
% leadsheet-core.sty
% Core preprocessing utilities and internal helpers for the leadsheet package
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{leadsheet-core}[2025/12/29 Leadsheet core preprocessing utilities]

\RequirePackage{soul}
\RequirePackage{calc}

\ExplSyntaxOn

% ============================================================================
% PREPROCESSING ENGINE
% ============================================================================
% The preprocessing engine transforms user-friendly syntax into LaTeX commands.
% This includes handling barlines, chord syntax, progressions, and special symbols.

% --- Variables ---

% Input token list for preprocessing
\tl_new:N \l__leadsheet_preproc_input_tl
% Output token list (currently unused, but reserved for future use)
\tl_new:N \l__leadsheet_preproc_output_tl

% --- Helper functions ---

% \__leadsheet_escape_hash:N <tl>
% Escapes literal # characters to \# in a token list
\cs_new_protected:Npn \__leadsheet_escape_hash:N #1 {
    \regex_replace_all:nnN { \cP\# } { \c{\#} } #1
}

% \__leadsheet_escape_caret:N <tl>
% Escapes literal ^ characters to \textasciicircum in a token list
\cs_new_protected:Npn \__leadsheet_escape_caret:N #1 {
    \regex_replace_all:nnN { \cU\^ } { \c{textasciicircum} } #1
}

% --- Public preprocessing function ---

% \__leadsheet_preprocess:n {<content>}
% Internal preprocessing function that transforms shorthand syntax into LaTeX commands.
% This is the main preprocessing engine used by lstabular and other environments.
%
% Transformations:
%   - "#" -> "\#" (hash symbol)
%   - "^" -> "\textasciicircum" (caret)
%   - ":||" -> "\lsrepend" (repeat end barline)
%   - "||:" -> "\lsrepstart" (repeat start barline)
%   - "|" -> "\lsbarline" (regular barline)
%   - "<>" -> "\lsfill" (infinite fill space)
%   - "- &" -> "\lsjoin &" (join cells with dashes)
%   - "^{Name}" -> chord progression reference
%   - "^!{text}" -> annotation label
%   - "^nC" -> "n. C." (no chord annotation)
%   - "^CHORD" -> rendered chord
%
\cs_new_protected:Npn \__leadsheet_preprocess:n #1 {
    % Read the input parameter
    \tl_set:Nn \l__leadsheet_preproc_input_tl { #1 }

    % Escape literal symbols
    \__leadsheet_escape_hash:N \l__leadsheet_preproc_input_tl
    \__leadsheet_escape_caret:N \l__leadsheet_preproc_input_tl

    % Normalize spacing around barlines for better alignment
    \regex_replace_all:nnN { \s*\|\s* } { \| } \l__leadsheet_preproc_input_tl
    \regex_replace_all:nnN { \s*:\|\|\s* } { :\|\| } \l__leadsheet_preproc_input_tl
    \regex_replace_all:nnN { \s*\|\|:\s* } { \|\|: } \l__leadsheet_preproc_input_tl

    % Replace barline symbols with formatting commands
    \regex_replace_all:nnN { :\|\| } { \c{lsrepend} } \l__leadsheet_preproc_input_tl
    \regex_replace_all:nnN { \|\|: } { \c{lsrepstart} } \l__leadsheet_preproc_input_tl
    \regex_replace_all:nnN { \| } { \c{lsbarline} } \l__leadsheet_preproc_input_tl

    % Replace special shorthand commands
    \tl_replace_all:Nnn \l__leadsheet_preproc_input_tl { >>> } { \lslspace }
    \tl_replace_all:Nnn \l__leadsheet_preproc_input_tl { >> } { \lsmspace }
    % \regex_replace_all:nnN { ^<> } { \c{lsfill}[0pt] } \l__leadsheet_preproc_input_tl
    \tl_replace_all:Nnn \l__leadsheet_preproc_input_tl { <> } { \lsfill }
    \regex_replace_all:nnN { -\s*& } { \c{lsjoin}& } \l__leadsheet_preproc_input_tl

    % Chord progressions: ^{Name} -> progression content
    \regex_replace_all:nnN { \c{textasciicircum}\cB\{(.*?)\cE\} }
                           { \c{__leadsheet_progression_use:n}\cB\{ \1 \cE\} }
                           \l__leadsheet_preproc_input_tl

    % Annotations: ^!{text} -> formatted annotation
    \regex_replace_all:nnN { \c{textasciicircum}\!\cB\{(.*?)\cE\} }
                           { \c{__leadsheet_chord_draw_annot:n}\cB\{ \1 \cE\} }
                           \l__leadsheet_preproc_input_tl

    % No-chord shorthand: ^nC -> "n. C." annotation
    \regex_replace_all:nnN { \c{textasciicircum}nC }
                           { \c{__leadsheet_chord_draw_nc:} }
                           \l__leadsheet_preproc_input_tl

    % Chord symbols: ^CHORD -> rendered chord
    \regex_replace_all:nnN { \c{textasciicircum}(\S*) }
                           { \c{__leadsheet_chord_draw:n}{\1} \c{lssspace} }
                           \l__leadsheet_preproc_input_tl

    % Return the preprocessed result
    \tl_use:N \l__leadsheet_preproc_input_tl
}


% ============================================================================
% BARLINE FORMATTING
% ============================================================================
% Commands for drawing different types of barlines in leadsheets.

% --- Dimensions ---

% Width of regular barlines
\newlength{\lsbarlinewidth}
\setlength{\lsbarlinewidth}{1pt}

% Width of repeat barlines
\newlength{\lsreplinewidth}
\setlength{\lsreplinewidth}{2pt}

% Width of space within repeat barlines
\newlength{\lsreplinesep}
\setlength{\lsreplinesep}{1.5pt}

% --- Public barline commands ---

% Regular barline: |
\newcommand{\lsbarline}{\llap{%
    \rule[-\dp\strutbox]{\lsbarlinewidth}{\dimexpr\ht\strutbox+\dp\strutbox}%
    \kern1pt%
}\ignorespaces}

% Repeat start barline: ||:
\newcommand{\lsrepstart}{\llap{%
    \rule[-\dp\strutbox]{\lsreplinewidth}{\dimexpr\ht\strutbox+\dp\strutbox}%
    \kern\lsreplinesep%
    \rule[-\dp\strutbox]{\lsbarlinewidth}{\dimexpr\ht\strutbox+\dp\strutbox}%
    \large{:}%
}\ignorespaces}

% Repeat end barline: :||
\newcommand{\lsrepend}{\llap{%
    \large{:}%
    \rule[-\dp\strutbox]{\lsbarlinewidth}{\dimexpr\ht\strutbox+\dp\strutbox}%
    \kern\lsreplinesep%
    \rule[-\dp\strutbox]{\lsreplinewidth}{\dimexpr\ht\strutbox+\dp\strutbox}%
    \kern1pt%
}\ignorespaces}


% ============================================================================
% LAYOUT UTILITIES
% ============================================================================

% \lsfill
% Creates a fill space with the highest order of infinity (1filll).
% Used to push apart sections of lyrics within a line.
\newcommand{\lsfill}[1][0.5em]{\nobreak\hskip #1 plus 1filll\nobreak}

% \lsjoin
% Connects two table cells with a dash, used before column separator "&".
% Inserts three equal stretchable spaces, while the center part is filled with dashes.
\newcommand{\lsjoin}{%
    \hskip 0pt plus 1fil% Left space
    \cleaders\hbox{\rule[0.5ex]{0.1em}{0.4pt}}\hskip 0pt plus 1fil% Center space, filled with dashes
    \hspace*{-2\tabcolsep}% Right space will be created by the column padding, but subtract the column separator width
}

% \lssspace \lsmspace \lslspace
% Inserts small, medium, or large horizontal space. Default after each chord symbol.
\newcommand{\lssspace}{\hspace{0.25em}}
\newcommand{\lsmspace}{\qquad}
\newcommand{\lslspace}{\qquad\qquad}


\ExplSyntaxOff

\endinput
